{% import "_includes/forms" as forms %}

{{ forms.lightswitchField({
    label: "Enable Bramble Search"|t('bramble-search'),
    instructions: "Replace Craft's search service with enhanced BM25 ranking algorithm, fuzzy search capabilities, and performance optimizations."|t('bramble-search'),
    tip: "When enabled, this affects both the admin Control Panel and frontend templates with improved search relevance and speed."|t('bramble-search'),
    id: 'enabled',
    name: 'enabled',
    on: settings.enabled,
    errors: settings.getErrors('enabled'),
}) }}

{% set redisAvailable = craft.app.plugins.getPlugin('bramble-search').isRedisAvailable() %}
{% set mongoDbAvailable = craft.app.plugins.getPlugin('bramble-search').isMongoDbAvailable() %}

{% set storageOptions = [
    { value: 'craft', label: 'Craft Cache' },
] %}

{% if redisAvailable %}
    {% set storageOptions = [
        { value: 'redis', label: 'Redis (Fastest)' },
    ]|merge(storageOptions) %}
{% endif %}

{% set storageOptions = [
    { value: 'file', label: 'File Storage' },
    { value: 'mysql', label: 'MySQL' },
]|merge(storageOptions) %}

{% if mongoDbAvailable %}
    {% set storageOptions = [
        { value: 'mongodb', label: 'MongoDB' },
    ]|merge(storageOptions) %}
{% endif %}

{# Reorder the options to match our speed ranking #}
{% set finalStorageOptions = [] %}
{% for driver in ['redis', 'file', 'mysql', 'mongodb', 'craft'] %}
    {% for option in storageOptions %}
        {% if option.value == driver %}
            {% set finalStorageOptions = finalStorageOptions|merge([option]) %}
        {% endif %}
    {% endfor %}
{% endfor %}

{% set storageOptions = finalStorageOptions %}

{{ forms.selectField({
    label: "Storage Driver"|t('bramble-search'),
    instructions: "Choose where to store the search index. Redis offers the best performance, while Craft Cache requires no additional setup."|t('bramble-search'),
    tip: "This can be overridden using the BRAMBLE_SEARCH_DRIVER environment variable in your .env file."|t('bramble-search'),
    id: 'storageDriver',
    name: 'storageDriver',
    options: storageOptions,
    value: settings.storageDriver,
    errors: settings.getErrors('storageDriver'),
    toggle: true,
    targetPrefix: 'storage-'
}) }}

{# Storage Configuration Section #}
{{ forms.field({
    label: "Storage Configuration"|t('bramble-search'),
    instructions: "Configure storage backend specific settings."|t('bramble-search'),
}, null) }}

<div id="storage-redis" class="{% if settings.storageDriver != 'redis' %}hidden{% endif %}">
    {{ forms.textField({
        label: "Redis Host"|t('bramble-search'),
        instructions: "The hostname or IP address of your Redis server."|t('bramble-search'),
        tip: "For local development, this is typically 'localhost' or '127.0.0.1'. Can be overridden with the BRAMBLE_SEARCH_REDIS_HOST environment variable."|t('bramble-search'),
        id: 'redisHost',
        name: 'redisHost',
        placeholder: 'localhost',
        value: settings.redisHost,
        errors: settings.getErrors('redisHost'),
        required: true,
    }) }}

    {{ forms.textField({
        label: "Redis Port"|t('bramble-search'),
        instructions: "The port your Redis server is listening on."|t('bramble-search'),
        tip: "The default Redis port is 6379. Can be overridden with the BRAMBLE_SEARCH_REDIS_PORT environment variable."|t('bramble-search'),
        id: 'redisPort',
        name: 'redisPort',
        placeholder: '6379',
        value: settings.redisPort,
        type: 'number',
        min: 1,
        max: 65535,
        errors: settings.getErrors('redisPort'),
        required: true,
    }) }}

    {{ forms.passwordField({
        label: "Redis Password"|t('bramble-search'),
        instructions: "The password for your Redis server (if required)."|t('bramble-search'),
        tip: "Leave blank if your Redis server doesn't require authentication. Can be overridden with the BRAMBLE_SEARCH_REDIS_PASSWORD environment variable."|t('bramble-search'),
        id: 'redisPassword',
        name: 'redisPassword',
        placeholder: 'Password',
        value: settings.redisPassword,
        errors: settings.getErrors('redisPassword'),
    }) }}
</div>

<div id="storage-mongodb" class="{% if settings.storageDriver != 'mongodb' %}hidden{% endif %}">
    {{ forms.textField({
        label: "MongoDB URI"|t('bramble-search'),
        instructions: "The connection URI for your MongoDB server."|t('bramble-search'),
        tip: "For local development, this is typically 'mongodb://localhost:27017'. Can be overridden with the BRAMBLE_SEARCH_MONGODB_URI environment variable."|t('bramble-search'),
        id: 'mongoDbUri',
        name: 'mongoDbUri',
        placeholder: 'mongodb://localhost:27017',
        value: settings.mongoDbUri,
        errors: settings.getErrors('mongoDbUri'),
        required: true,
    }) }}

    {{ forms.textField({
        label: "MongoDB Database"|t('bramble-search'),
        instructions: "The name of the MongoDB database to use."|t('bramble-search'),
        tip: "This database will be created if it doesn't exist. Can be overridden with the BRAMBLE_SEARCH_MONGODB_DATABASE environment variable."|t('bramble-search'),
        id: 'mongoDbDatabase',
        name: 'mongoDbDatabase',
        placeholder: 'bramble_search',
        value: settings.mongoDbDatabase,
        errors: settings.getErrors('mongoDbDatabase'),
        required: true,
    }) }}
</div>

<hr>

{# Search Algorithm Configuration Section #}
{{ forms.field({
    label: "Search Algorithm Configuration"|t('bramble-search'),
    instructions: "Configure the BM25 ranking algorithm parameters and boosting factors for optimal search relevance."|t('bramble-search'),
}, null) }}

{{ forms.textField({
    label: "BM25 K1 Parameter"|t('bramble-search'),
    instructions: "Controls how quickly term frequency scoring saturates. Lower values make term frequency less important, higher values give more weight to repeated terms."|t('bramble-search'),
    tip: "Range: 0.1-5.0. Default of 1.5 works well for most content. Lower values (0.5-1.0) for documents with repeated keywords, higher values (2.0-5.0) for varied vocabulary."|t('bramble-search'),
    id: 'bm25K1',
    name: 'bm25K1',
    value: settings.bm25K1,
    type: 'number',
    min: 0.1,
    max: 5.0,
    step: 0.1,
    size: 5,
    errors: settings.getErrors('bm25K1'),
}) }}

{{ forms.textField({
    label: "BM25 B Parameter"|t('bramble-search'),
    instructions: "Controls document length normalization. 0 means document length doesn't affect scoring, 1 means shorter documents are heavily favored."|t('bramble-search'),
    tip: "Range: 0.0-1.0. Default of 0.75 balances relevance with document length. Use 0 for uniform document lengths, 1 when document length is very important."|t('bramble-search'),
    id: 'bm25B',
    name: 'bm25B',
    value: settings.bm25B,
    type: 'number',
    min: 0.0,
    max: 1.0,
    step: 0.05,
    size: 5,
    errors: settings.getErrors('bm25B'),
}) }}

{{ forms.textField({
    label: "Title Boost Factor"|t('bramble-search'),
    instructions: "Multiplier applied to terms found in title fields to increase their relevance in search results."|t('bramble-search'),
    tip: "Range: 1.0-20.0. Default of 5.0 significantly boosts title matches. Higher values (10.0+) make title matches dominant, lower values (2.0-3.0) provide subtle boosting."|t('bramble-search'),
    id: 'titleBoostFactor',
    name: 'titleBoostFactor',
    value: settings.titleBoostFactor,
    type: 'number',
    min: 1.0,
    max: 20.0,
    step: 0.5,
    size: 5,
    errors: settings.getErrors('titleBoostFactor'),
}) }}

{{ forms.textField({
    label: "Exact Match Boost Factor"|t('bramble-search'),
    instructions: "Multiplier applied when all search terms appear as an exact phrase in the document."|t('bramble-search'),
    tip: "Range: 1.0-20.0. Default of 3.0 moderately boosts exact phrase matches. Higher values favor exact matches, lower values reduce the exact match advantage."|t('bramble-search'),
    id: 'exactMatchBoostFactor',
    name: 'exactMatchBoostFactor',
    value: settings.exactMatchBoostFactor,
    type: 'number',
    min: 1.0,
    max: 20.0,
    step: 0.5,
    size: 5,
    errors: settings.getErrors('exactMatchBoostFactor'),
}) }}

{# Fuzzy Search Configuration Section #}
    {{ forms.checkboxGroupField({
        label: "N-gram Sizes"|t('bramble-search'),
        instructions: "Select the n-gram sizes to generate for fuzzy matching. Multiple sizes provide better accuracy."|t('bramble-search'),
        tip: "Smaller sizes (2-3) are faster but less precise. Larger sizes (4-5) are more precise but slower. Default combination of 2-3 grams provides good balance."|t('bramble-search'),
        id: 'ngramSizes',
        name: 'ngramSizes',
        values: settings.ngramSizes,
        options: [
            { value: '1', label: '1-gram (unigram) - Best for very short terms' },
            { value: '2', label: '2-gram (bigram) - Fast, broad matching' },
            { value: '3', label: '3-gram (trigram) - Balanced speed and precision' },
            { value: '4', label: '4-gram - Precise but slower' },
            { value: '5', label: '5-gram - Most precise, slowest' },
        ],
        errors: settings.getErrors('ngramSizes'),
    }) }}

    {{ forms.textField({
        label: "Similarity Threshold"|t('bramble-search'),
        instructions: "Minimum n-gram similarity score (0-1) for fuzzy search candidates. Lower values find more matches but may include irrelevant results."|t('bramble-search'),
        tip: "Range: 0.0-1.0. Default of 0.25 optimized for short terms. Lower values (0.1-0.2) for very broad matching, higher values (0.4-0.6) for strict matching."|t('bramble-search'),
        id: 'ngramSimilarityThreshold',
        name: 'ngramSimilarityThreshold',
        value: settings.ngramSimilarityThreshold,
        type: 'number',
        min: 0.0,
        max: 1.0,
        step: 0.05,
        size: 5,
        errors: settings.getErrors('ngramSimilarityThreshold'),
    }) }}

    {{ forms.textField({
        label: "Max Fuzzy Candidates"|t('bramble-search'),
        instructions: "Maximum number of candidate terms to process for fuzzy matching. Higher values improve accuracy but reduce performance."|t('bramble-search'),
        tip: "Range: 10-1000. Default of 100 balances accuracy with performance. Increase for better fuzzy matching, decrease for faster searches."|t('bramble-search'),
        id: 'fuzzySearchMaxCandidates',
        name: 'fuzzySearchMaxCandidates',
        value: settings.fuzzySearchMaxCandidates,
        type: 'number',
        min: 10,
        max: 1000,
        step: 10,
        size: 5,
        errors: settings.getErrors('fuzzySearchMaxCandidates'),
    }) }}

<hr>

{# Index Management Section #}
{{ forms.field({
    label: "Index Management"|t('bramble-search'),
    instructions: "The search index is automatically maintained as content is created and updated."|t('bramble-search'),
}, null) }}

{{ forms.field({
    id: 'rebuild-instructions',
    fieldClass: 'first',
}, '<p class="light">' ~ "If you need to rebuild the entire search index because you cleared the cache manually or changed the storage driver, you have two options:"|t('bramble-search') ~ '</p>
    <div class="meta" style="margin-bottom:12px;">

    <div class="field">
        <div class="heading">
            <label>' ~ "Via the Control Panel"|t('bramble-search') ~ '</label>
        </div>
        <div class="input">
            <p>' ~ "Go to"|t('bramble-search') ~ ' <em>' ~ "Utilities"|t('bramble-search') ~ ' → ' ~ "Clear Caches"|t('bramble-search') ~ '</em> ' ~ "and select"|t('bramble-search') ~ ' <em>' ~ "Bramble Search"|t('bramble-search') ~ '</em>.</p>
        </div>
    </div>

    <div class="field">
        <div class="heading">
            <label>' ~ "Via the Command Line"|t('bramble-search') ~ '</label>
        </div>
        <div class="input">
            <p>' ~ "Run the command"|t('bramble-search') ~ ' <code>./craft clear-caches/all</code> ' ~ "or"|t('bramble-search') ~ ' <code>./craft clear-caches/bramble-search</code>.</p>
        </div>
    </div>

    </div>

    <small class="light">' ~ "Note: Rebuilding the index may take some time depending on the size of your site."|t('bramble-search') ~ '</small>') }}

{% js %}
document.addEventListener('DOMContentLoaded', function() {
    var storageDriverSelect = document.getElementById('storageDriver');
    var redisSettings = document.getElementById('storage-redis');
    var mongoDbSettings = document.getElementById('storage-mongodb');

    // Function to check storage driver value and toggle visibility
    function updateStorageVisibility() {
        if (!storageDriverSelect || !redisSettings || !mongoDbSettings) {
            return;
        }
        
        var value = storageDriverSelect.value;

        // Redis settings
        if (value === 'redis') {
            redisSettings.classList.remove('hidden');
        } else {
            redisSettings.classList.add('hidden');
        }

        // MongoDB settings
        if (value === 'mongodb') {
            mongoDbSettings.classList.remove('hidden');
        } else {
            mongoDbSettings.classList.add('hidden');
        }
    }

    // Initial check (only if elements exist)
    if (storageDriverSelect) {
        updateStorageVisibility();
    }

    // Listen for changes (only if elements exist)
    if (storageDriverSelect) {
        storageDriverSelect.addEventListener('change', updateStorageVisibility);
    }
});
{% endjs %}